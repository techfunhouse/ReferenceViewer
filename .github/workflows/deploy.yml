name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main  # Set your default branch here if it's not 'main'

permissions:
  contents: write  # This is crucial - gives permission to write to the repository

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
        
      - name: Prepare for routing
        run: |
          # Create a .nojekyll file to bypass GitHub Pages Jekyll processing
          touch dist/public/.nojekyll
          
          # Copy index.html to 404.html for client-side routing
          cp dist/public/index.html dist/public/404.html
          
          # Copy GitHub Pages specific index file to the root
          cp github-pages-index.html dist/public/index.html
          
          # Create a _redirects file for SPA routing
          echo "/*    /index.html   200" > dist/public/_redirects
          
          # Add base path to index.html for GitHub Pages deployment
          sed -i 's/<head>/<head><base href="\/ReferenceViewer\/">/' dist/public/index.html
          sed -i 's/<head>/<head><base href="\/ReferenceViewer\/">/' dist/public/404.html
          
          # Create a script to handle routing
          cat > dist/public/routing-handler.js << 'EOL'
          // Handle client-side routing for GitHub Pages
          (function() {
            // Get the base path from the base tag
            const basePath = document.querySelector('base').getAttribute('href');
            
            // Listen for navigation and handle SPA routing
            window.addEventListener('popstate', function() {
              const path = window.location.pathname;
              // Redirect to base path if not already within it
              if (!path.startsWith(basePath)) {
                window.location.replace(basePath + path.replace(/^\//, ''));
              }
            });
            
            // Handle initial load
            if (!window.location.pathname.startsWith(basePath)) {
              window.history.replaceState(null, null, basePath);
            }
          })();
          EOL
          
          # Add the routing script to both index.html and 404.html
          sed -i 's/<\/head>/<script src="\/ReferenceViewer\/routing-handler.js"><\/script><\/head>/' dist/public/index.html
          sed -i 's/<\/head>/<script src="\/ReferenceViewer\/routing-handler.js"><\/script><\/head>/' dist/public/404.html
      
      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages  # The branch the action should deploy to
          folder: dist/public  # The folder the action should deploy
          clean: true  # Automatically remove deleted files from deploy branch